<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eon v2 (Final - India)</title>
    <!-- Using Tailwind CSS for professional styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .app-container { max-width: 420px; margin: 2rem auto; background: white; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); overflow: hidden; border: 4px solid #1f2937; }
        .app-header { background-color: #1f2937; color: white; padding: 1.5rem; text-align: center; }
        .app-header h1 { font-size: 1.75rem; font-weight: 700; }
        .app-header p { font-size: 0.875rem; opacity: 0.8; }
        .app-content { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .feature-card { background: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb; }
        .feature-card h2 { font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 0.75rem; }
        .feature-card p { font-size: 0.875rem; color: #4b5563; margin-bottom: 1rem; }
        
        /* Stage 2: Smart Form Styles */
        .form-group { margin-bottom: 0.75rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .form-input, .form-select { width: 100%; font-size: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; background-color: #ffffff; }
        .form-button-add { width: 100%; padding: 0.5rem; background-color: #3b82f6; color: white; font-weight: 600; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s; margin-bottom: 1rem; }
        .form-button-add:hover { background-color: #2563eb; }
        .test-queue-list { list-style: none; padding: 0; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 150px; overflow-y: auto; }
        .test-queue-item { display: flex; justify-content: space-between; align-items: center; background: #eef2ff; padding: 0.5rem; border-radius: 0.5rem; }
        .test-queue-item span { font-size: 0.875rem; font-family: 'Inter', sans-serif; font-weight: 500; color: #1e3a8a; }
        .test-queue-item button { font-size: 0.75rem; color: #ef4444; font-weight: 600; }
        .test-button-run { width: 100%; padding: 0.75rem; background-color: #16a34a; color: white; font-weight: 600; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .test-button-run:hover { background-color: #15803d; }
        
        /* Live result styles */
        .live-result-list { list-style: none; padding: 0; margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .live-result-item { display: flex; align-items: center; justify-content: space-between; background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .live-result-item .app-name { font-weight: 500; color: #1f2937; }
        .solution-text { font-size: 0.875rem; font-weight: 500; padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: white; text-align: center; }
        .solution-red { background-color: #ef4444; }
        .solution-yellow { background-color: #f59e0b; }
        .solution-green { background-color: #16a34a; }
        .solution-gray { background-color: #6b7280; } 
        
        /* Stage 1: Demo styles */
        .optimize-button { width: 100%; padding: 0.75rem; background-color: #2563eb; color: white; font-weight: 600; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .optimize-button:hover { background-color: #1d4ed8; }
        .optimize-button.loading { background-color: #9ca3af; cursor: not-allowed; }
        .result-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .result-item { display: flex; align-items: center; justify-content: space-between; background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; opacity: 0; transform: translateX(-10px); animation: fadeIn 0.3s ease-out forwards; }
        .result-item .app-name { font-weight: 500; color: #1f2937; }
        .result-item .app-reason { font-size: 0.875rem; color: #ef4444; }
        .preload-reason { font-size: 0.875rem; color: #16a34a; }
        .hibernate-reason { font-size: 0.875rem; color: #6b7280; }
        .action-button { padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; background-color: #e5e7eb; color: #374151; border-radius: 0.25rem; }
        
        .sleep-btn {
            background-color: #e5e7eb;
            cursor: pointer;
            }

        .sleep-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            }

        .preload-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .preload-btn:disabled {
            background-color: #16a34a;
            cursor: not-allowed;
        }

        .ira-sleep-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .ira-sleep-btn:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }

        .restrict-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .restrict-btn:disabled {
            background-color: #f59e0b;
            cursor: not-allowed;
        }

        .kill-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .kill-btn:disabled {
            background-color: #ef4444;
            cursor: not-allowed;
        }

        .stage2-kill-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .stage2-kill-btn:disabled {
            background-color: #ef4444;
            cursor: not-allowed;
        }

        .stage2-restrict-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .stage2-restrict-btn:disabled {
            background-color: #f59e0b;
            cursor: not-allowed;
        }

        .stage2-allow-btn {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .stage2-allow-btn:disabled {
            background-color: #16a34a;
            cursor: not-allowed;
        }

        .toggle-btn {
            font-size: 0.75rem;
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        @keyframes fadeIn { to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <header class="app-header">
            <h1>Eon</h1>
            <p>Eco-Optimization Nexus</p>
        </header>

        <main class="app-content">

            <!-- STAGE 2: LIVE MLOps TEST -->
            <section class="feature-card">
                <h2>Stage 2: Live MLOps Test (Verification)</h2>
                <p>Add "live" app data from your device to test our model.</p>
                
                <div id="test-form">
                    <div class="form-group">
                        <label for="app-name-input" class="form-label">App Name (from Colab Top 20)</label>
                        <select id="app-name-input" class="form-select">
                            <option value="com.whatsapp" data-priority="Foreground app">WhatsApp</option>
                            <option value="com.facebook.katana" data-priority="Service">Facebook</option>
                            <option value="com.google.android.youtube" data-priority="Service">YouTube</option>
                            <option value="com.google.android.gm" data-priority="Foreground app">Gmail</option>
                            <option value="com.spotify.music" data-priority="Service">Spotify</option>
                            <option value="com.instagram.android" data-priority="Service">Instagram</option>
                            <option value="com.google.android.calendar" data-priority="Foreground app">Calendar</option>
                            <option value="org.telegram.messenger" data-priority="Foreground app">Telegram</option>
                            <option value="com.snapchat.android" data-priority="Service">Snapchat</option>
                            <option value="com.twitter.android" data-priority="Service">Twitter</option>
                            <option value="com.android.chrome" data-priority="Foreground app">Chrome</option>
                            <option value="com.samsung.android.messaging" data-priority="Foreground app">Samsung Messages</option>
                            <option value="com.google.android.apps.maps" data-priority="Foreground app">Google Maps</option>
                            <option value="com.google.android.googlequicksearchbox" data-priority="Background process">Google Search</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label for="priority-input" class="form-label">Priority</label>
                            <select id="priority-input" class="form-select">
                                <option value="Service">Service</option>
                                <option value="Foreground app">Foreground app</option>
                                <option value="Background process">Background process</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status-input" class="form-label">Battery Status</label>
                            <select id="status-input" class="form-select">
                                <option value="discharging">Discharging</option>
                                <option value="charging">Charging</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="level-input" class="form-label">Battery Level (%)</label>
                        <input type="number" id="level-input" class="form-input" value="50" min="0" max="100" />
                    </div>
                    
                    <button id="add-to-queue-btn" class="form-button-add">Add to Queue</button>
                    
                    <ul id="test-queue-list" class="test-queue-list"></ul>
                    
                    <button id="run-test-btn" class="test-button-run">Run Test</button>
                    <ul id="live-results-list" class="live-result-list"></ul>
                </div>
            </section>

            <!-- STAGE 1: SMART BATTERY REGULATION -->
            <section class="feature-card">
                <h2>Stage 1: Smart Battery Regulation (Hypothesis)</h2>
                <p>Scan for known battery hogs based on analysis of the `mega_dataset.csv`.</p>
                <div id="optimize-button" class="optimize-button">
                    Run Smart Scan
                </div>
                <ul id="hit-list" class="result-list mt-4"></ul>
            </section>

            <!-- STAGE 1: INTELLIGENT RESOURCE ALLOCATION -->
            <section class="feature-card">
                <h2>Stage 1: Intelligent Resource Allocation (Hypothesis)</h2>
                <p id="preload-text">Loading your usage pattern...</p>
                <ul id="preload-list" class="result-list"></ul>
            </section>

            <!-- STAGE 1: ADAPTIVE CONNECTIVITY -->
            <section class="feature-card">
                <h2>Stage 1: Adaptive Connectivity (Hypothesis)</h2>
                <p id="connectivity-text">Checking your location...</p>
                <div id="connectivity-status"></div>
                <button id="simulate-loc-btn" class="optimize-button" style="margin-top: 1rem;">Toggle Travel Mode</button>
            </section>

        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ===== TRAINED MODEL DATA =====
            const TRAINED_MODEL = {
                "usage_map": {
                    "youtube": [0, 3, 7, 12, 13, 16, 20, 22, 23],
                    "instagram": [20, 21, 22],
                    "chrome": [7, 8, 9, 19, 20, 21, 22, 23],
                    "calendar": [8, 9, 10, 11, 14, 15],
                    "clock": [5, 6, 7, 22, 23],
                    "facebook": [],
                    "snapchat": [],
                    "whatsapp": [],
                    "spotify": [],
                    "gm": [20, 21, 22],
                    "maps": [],
                    "twitter": []
                },
                "connectivity": {
                    "home_timezone": "Asia/Kolkata",
                    "home_mcc": "unknown"
                },
                "blacklisted_apps": [
                    "bluetooth", "gms", "org", "phone", 
                    "exchange", "stk", "service", "fmm", "stk2"
                ]
            };

            // Battery drain apps from EDA (for Smart Battery Regulation)
            const BATTERY_DRAIN_APPS = [
                { name: "Facebook", reason: "High background service usage" },
                { name: "YouTube", reason: "Service-level execution with high power draw" },
                { name: "Instagram", reason: "Frequent background wake-ups" }
            ];

            // ===== STAGE 1: SMART BATTERY REGULATION ELEMENTS =====
            const scanButton = document.getElementById('optimize-button');
            const hitList = document.getElementById('hit-list');

            // ===== STAGE 1: INTELLIGENT RESOURCE ALLOCATION ELEMENTS =====
            const preloadText = document.getElementById('preload-text');
            const preloadList = document.getElementById('preload-list');

            // ===== STAGE 2 ELEMENTS =====
            const appNameInput = document.getElementById('app-name-input');
            const priorityInput = document.getElementById('priority-input');
            const statusInput = document.getElementById('status-input');
            const levelInput = document.getElementById('level-input');
            const addToQueueBtn = document.getElementById('add-to-queue-btn');
            const testQueueList = document.getElementById('test-queue-list');
            const runTestButton = document.getElementById('run-test-btn');
            const liveResultsList = document.getElementById('live-results-list');
            let testQueue = []; 

            // ===== STAGE 3 ELEMENTS =====
            const connectivityText = document.getElementById('connectivity-text');
            const connectivityStatus = document.getElementById('connectivity-status');
            const simulateLocBtn = document.getElementById('simulate-loc-btn');
            let isSimulatedTravel = false; 

            // ===== HELPER FUNCTIONS =====
            function getSimpleAppName(fullName) {
                const parts = fullName.split('.');
                return parts[parts.length - 1];
            }

            function getDisplayName(simpleName) {
                const nameMap = {
                    'youtube': 'YouTube',
                    'instagram': 'Instagram',
                    'chrome': 'Chrome',
                    'calendar': 'Calendar',
                    'clock': 'Clock',
                    'spotify': 'Spotify',
                    'maps': 'Google Maps',
                    'facebook': 'Facebook',
                    'snapchat': 'Snapchat',
                    'whatsapp': 'WhatsApp',
                    'twitter': 'Twitter',
                    'gm': 'Gmail'
                };
                return nameMap[simpleName] || simpleName;
            }

            function getAppSolution(app, batteryStatus, batteryLevel) {
                const battLow = batteryLevel < 20;
                const battCritical = batteryLevel < 10;
                const isDischarging = batteryStatus === 'discharging';
                const priority = app.priority;

                if (battCritical && isDischarging) {
                    if (priority === 'Service' || priority === 'Background process') {
                        return { solution: 'Kill', reason: 'Critical battery', color: 'solution-red' };
                    } else {
                        return { solution: 'Slow Down', reason: 'Critical battery', color: 'solution-yellow' };
                    }
                }

                if (battLow && isDischarging) {
                    if (priority === 'Service') {
                        return { solution: 'Slow Down', reason: 'Low battery', color: 'solution-yellow' };
                    } else if (priority === 'Foreground app') {
                        return { solution: 'Allow', reason: 'User active', color: 'solution-green' };
                    } else {
                        return { solution: 'Kill', reason: 'Low battery', color: 'solution-red' };
                    }
                }

                if (priority === 'Foreground app') {
                    return { solution: 'Allow', reason: 'User active', color: 'solution-green' };
                } else if (priority === 'Service') {
                    return { solution: 'Slow Down', reason: 'Background service', color: 'solution-yellow' };
                } else {
                    return { solution: 'Kill', reason: 'Background process', color: 'solution-red' };
                }
            }

            // ===== STAGE 1: SMART BATTERY REGULATION EVENT LISTENER =====
            if (scanButton) {
                scanButton.addEventListener('click', () => {
                    if (scanButton.classList.contains('loading')) return;
                    scanButton.classList.add('loading');
                    scanButton.textContent = 'Scanning...';
                    hitList.innerHTML = ''; 
                    setTimeout(() => {
                        BATTERY_DRAIN_APPS.forEach((app, index) => {
                            const li = document.createElement('li');
                            li.className = 'result-item';
                            li.style.animationDelay = `${index * 0.1}s`;
                            li.innerHTML = `
                                <div>
                                    <div class="app-name">${app.name}</div>
                                    <div class="app-reason">${app.reason}</div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-button restrict-btn" data-app="${app.name}">Restrict</button>
                                    <button class="action-button sleep-btn" data-app="${app.name}">Sleep</button>
                                    <button class="action-button kill-btn" data-app="${app.name}">Kill</button>
                                </div>
                            `;
                            hitList.appendChild(li);
                        });
                        scanButton.classList.remove('loading');
                        scanButton.textContent = 'Scan Complete!';
                    }, 2000); 
                });
            }

            hitList.addEventListener("click", (e) => {
                const button = e.target;
                if (!button.classList.contains("restrict-btn") && 
                    !button.classList.contains("sleep-btn") && 
                    !button.classList.contains("kill-btn")) return;

                const card = button.closest(".result-item");
                const appName = button.dataset.app;
                const reasonText = card.querySelector(".app-reason");
                const buttonsContainer = card.querySelector('div[style*="display: flex"]');

                // If Kill is clicked, remove the entire card with animation
                if (button.classList.contains("kill-btn")) {
                    card.style.transition = "opacity 0.3s, transform 0.3s";
                    card.style.opacity = "0";
                    card.style.transform = "translateX(-20px)";
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                    return;
                }

                // For Restrict and Sleep, check if already applied (for undo)
                const isAlreadyRestricted = button.classList.contains("active-restricted");
                const isAlreadySleeping = button.classList.contains("active-sleeping");

                if (button.classList.contains("restrict-btn")) {
                    if (isAlreadyRestricted) {
                        // Undo Restrict
                        button.textContent = "Restrict";
                        button.style.backgroundColor = "";
                        button.style.color = "";
                        button.classList.remove("active-restricted");
                        card.classList.remove("opacity-60");
                        buttonsContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        if (reasonText) {
                            const originalReason = BATTERY_DRAIN_APPS.find(app => app.name === appName)?.reason || "Battery hog detected";
                            reasonText.textContent = originalReason;
                            reasonText.style.color = "#ef4444";
                        }
                    } else {
                        // Apply Restrict
                        buttonsContainer.querySelectorAll('button').forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove("active-sleeping");
                        });
                        button.disabled = false;
                        button.textContent = "Restricted âš  (Click to Undo)";
                        button.style.backgroundColor = "#f59e0b";
                        button.style.color = "white";
                        button.classList.add("active-restricted");
                        card.classList.add("opacity-60");
                        if (reasonText) {
                            reasonText.textContent = "Background data limited";
                            reasonText.style.color = "#f59e0b";
                        }
                    }
                } else if (button.classList.contains("sleep-btn")) {
                    if (isAlreadySleeping) {
                        // Undo Sleep
                        button.textContent = "Sleep";
                        button.style.backgroundColor = "";
                        button.style.color = "";
                        button.classList.remove("active-sleeping");
                        card.classList.remove("opacity-60");
                        buttonsContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        if (reasonText) {
                            const originalReason = BATTERY_DRAIN_APPS.find(app => app.name === appName)?.reason || "Battery hog detected";
                            reasonText.textContent = originalReason;
                            reasonText.style.color = "#ef4444";
                        }
                    } else {
                        // Apply Sleep
                        buttonsContainer.querySelectorAll('button').forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove("active-restricted");
                        });
                        button.disabled = false;
                        button.textContent = "Sleeping ðŸ’¤ (Click to Undo)";
                        button.style.backgroundColor = "#9ca3af";
                        button.style.color = "white";
                        button.classList.add("active-sleeping");
                        card.classList.add("opacity-60");
                        if (reasonText) {
                            reasonText.textContent = "Background activity paused";
                            reasonText.style.color = "#6b7280";
                        }
                    }
                }
            });

            // ===== STAGE 2 EVENT LISTENERS =====
            if (appNameInput) {
                appNameInput.addEventListener('change', () => {
                    const selectedOption = appNameInput.options[appNameInput.selectedIndex];
                    const autoPriority = selectedOption.getAttribute('data-priority');
                    priorityInput.value = autoPriority; 
                });
            }

            if (addToQueueBtn) {
                addToQueueBtn.addEventListener('click', () => {
                    const processName = appNameInput.value;
                    const selectedOption = appNameInput.options[appNameInput.selectedIndex];
                    const autoPriority = selectedOption.getAttribute('data-priority');
                    
                    const app = {
                        processName: processName,
                        simpleName: getSimpleAppName(processName),
                        displayName: selectedOption.text,
                        priority: autoPriority 
                    };
                    
                    testQueue.push(app); 
                    renderTestQueue(); 
                });
            }
            
            if (runTestButton) {
                runTestButton.addEventListener('click', () => {
                    liveResultsList.innerHTML = ''; 
                    const batteryStatus = statusInput.value;
                    const batteryLevel = parseInt(levelInput.value) || 100;

                    if (testQueue.length === 0) {
                        liveResultsList.innerHTML = `<li class="live-result-item"><span class="solution-text solution-yellow">Add an app to the queue first!</span></li>`;
                        return;
                    }
                    
                    testQueue.forEach(app => {
                        const result = getAppSolution(app, batteryStatus, batteryLevel);
                        const li = document.createElement('li');
                        li.className = 'live-result-item';
                        
                        // Determine which buttons to show based on the solution
                        let buttonsHTML = '';
                        if (result.solution === 'Kill') {
                            buttonsHTML = `
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-button stage2-kill-btn" data-app="${app.displayName}" data-reason="${result.reason}">Kill</button>
                                </div>
                            `;
                        } else if (result.solution === 'Slow Down') {
                            buttonsHTML = `
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-button stage2-restrict-btn" data-app="${app.displayName}" data-reason="${result.reason}">Slow Down</button>
                                    <button class="action-button stage2-kill-btn" data-app="${app.displayName}" data-reason="${result.reason}">Kill</button>
                                </div>
                            `;
                        } else if (result.solution === 'Allow') {
                            buttonsHTML = `
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-button stage2-allow-btn" data-app="${app.displayName}" data-reason="${result.reason}">Allow</button>
                                </div>
                            `;
                        }
                        
                        li.innerHTML = `
                            <div>
                                <div class="app-name">${app.displayName}</div> 
                                <div class="stage2-reason text-xs text-gray-500">${result.reason}</div>
                            </div>
                            ${buttonsHTML}
                        `;
                        liveResultsList.appendChild(li);
                    });
                });
            }

            function renderTestQueue() {
                testQueueList.innerHTML = '';
                testQueue.forEach((app, index) => {
                    const li = document.createElement('li');
                    li.className = 'test-queue-item';
                    li.innerHTML = `
                        <span>${app.displayName}</span>
                        <button data-index="${index}" class="remove-btn">âœ–</button>
                    `;
                    testQueueList.appendChild(li);
                });
            }
            
            testQueueList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const indexToRemove = parseInt(e.target.dataset.index);
                    testQueue.splice(indexToRemove, 1); 
                    renderTestQueue(); 
                }
            });

            // Event listener for Stage 2 action buttons
            liveResultsList.addEventListener('click', (e) => {
                const button = e.target;
                if (!button.classList.contains('stage2-kill-btn') && 
                    !button.classList.contains('stage2-restrict-btn') && 
                    !button.classList.contains('stage2-allow-btn')) return;

                const card = button.closest('.live-result-item');
                const appName = button.dataset.app;
                const originalReason = button.dataset.reason;
                const reasonText = card.querySelector('.stage2-reason');
                const buttonsContainer = card.querySelector('div[style*="display: flex"]');

                // If Kill is clicked, remove the entire card with animation
                if (button.classList.contains('stage2-kill-btn')) {
                    card.style.transition = "opacity 0.3s, transform 0.3s";
                    card.style.opacity = "0";
                    card.style.transform = "translateX(-20px)";
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                    return;
                }

                // Check if button is already active (for undo)
                const isAlreadyActive = button.classList.contains('active-stage2');

                if (button.classList.contains('stage2-restrict-btn')) {
                    if (isAlreadyActive) {
                        // Undo Slow Down
                        button.textContent = "Slow Down";
                        button.style.backgroundColor = "";
                        button.style.color = "";
                        button.classList.remove('active-stage2');
                        card.classList.remove("opacity-60");
                        buttonsContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        if (reasonText) {
                            reasonText.textContent = originalReason;
                            reasonText.style.color = "";
                        }
                    } else {
                        // Apply Slow Down
                        buttonsContainer.querySelectorAll('button').forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove('active-stage2');
                        });
                        button.disabled = false;
                        button.textContent = "Slowed âš  (Click to Undo)";
                        button.style.backgroundColor = "#f59e0b";
                        button.style.color = "white";
                        button.classList.add('active-stage2');
                        card.classList.add("opacity-60");
                        if (reasonText) {
                            reasonText.textContent = "App throttled to save battery";
                            reasonText.style.color = "#f59e0b";
                        }
                    }
                } else if (button.classList.contains('stage2-allow-btn')) {
                    if (isAlreadyActive) {
                        // Undo Allow
                        button.textContent = "Allow";
                        button.style.backgroundColor = "";
                        button.style.color = "";
                        button.classList.remove('active-stage2');
                        card.classList.remove("opacity-60");
                        if (reasonText) {
                            reasonText.textContent = originalReason;
                            reasonText.style.color = "";
                        }
                    } else {
                        // Apply Allow
                        button.disabled = false;
                        button.textContent = "Allowed âœ“ (Click to Undo)";
                        button.style.backgroundColor = "#16a34a";
                        button.style.color = "white";
                        button.classList.add('active-stage2');
                        card.classList.add("opacity-60");
                        if (reasonText) {
                            reasonText.textContent = "App running at full capacity";
                            reasonText.style.color = "#16a34a";
                        }
                    }
                }
            });
            
            if (simulateLocBtn) {
                simulateLocBtn.addEventListener('click', () => {
                    isSimulatedTravel = !isSimulatedTravel; 
                    runConnectivityLogic(); 
                });
            }

            // ===== STAGE 1: INTELLIGENT RESOURCE ALLOCATION =====
            function runResourceAllocation() {
                if (!preloadText || !preloadList) return; 
                preloadList.innerHTML = ''; 
                
                const now = new Date();
                const currentHour = now.getHours(); 
                
                const ampm = currentHour >= 12 ? 'PM' : 'AM';
                const hour12 = currentHour % 12 || 12;
                
                preloadText.textContent = `It's ${hour12} ${ampm}. Based on your training data:`;
                
                const EXCLUDED_APPS = ['phone', 'whatsapp', 'gmail', 'mail', 'gm'];
                const DISPLAY_APPS = ['youtube', 'instagram', 'chrome', 'calendar', 'clock', 'spotify', 'maps'];
                
                // Only show apps that should be preloaded at this hour
                for (const [appName, allowedHours] of Object.entries(TRAINED_MODEL.usage_map)) {
                    if (EXCLUDED_APPS.includes(appName) || !DISPLAY_APPS.includes(appName)) continue;
                    
                    // Only display if this hour is in the allowed hours
                    if (allowedHours.includes(currentHour)) {
                        const li = document.createElement('li');
                        li.className = 'result-item';
                        li.innerHTML = `
                            <div>
                                <div class="app-name">${getDisplayName(appName)}</div>
                                <div class="preload-reason">Preloaded - High usage at ${hour12}:00 ${ampm}</div>
                            </div>
                            <button class="action-button ira-sleep-btn" data-app="${appName}">Sleep Anyway</button>
                        `;
                        preloadList.appendChild(li);
                    }
                }
                
                // If no apps to preload at this hour
                if (preloadList.children.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    li.innerHTML = `
                        <div>
                            <div class="text-gray-500 text-sm">No apps need preloading at ${hour12}:00 ${ampm}</div>
                        </div>
                    `;
                    preloadList.appendChild(li);
                }
            }

            // Event listener for Sleep Anyway button in IRA
            preloadList.addEventListener("click", (e) => {
                const button = e.target;
                if (!button.classList.contains("ira-sleep-btn")) return;

                const card = button.closest(".result-item");
                const appName = button.dataset.app;
                const reasonText = card.querySelector(".preload-reason");

                // Check if already sleeping (for undo)
                const isAlreadySleeping = button.classList.contains("active-sleeping");

                if (isAlreadySleeping) {
                    // Undo Sleep - restore to preloaded state
                    button.textContent = "Sleep Anyway";
                    button.style.backgroundColor = "";
                    button.style.color = "";
                    button.classList.remove("active-sleeping");
                    card.classList.remove("opacity-60");
                    if (reasonText) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const ampm = currentHour >= 12 ? 'PM' : 'AM';
                        const hour12 = currentHour % 12 || 12;
                        reasonText.textContent = `Preloaded - High usage at ${hour12}:00 ${ampm}`;
                        reasonText.style.color = "#16a34a";
                    }
                } else {
                    // Apply Sleep
                    button.textContent = "Sleeping ðŸ’¤ (Click to Undo)";
                    button.style.backgroundColor = "#6b7280";
                    button.style.color = "white";
                    button.classList.add("active-sleeping");
                    card.classList.add("opacity-60");
                    if (reasonText) {
                        reasonText.textContent = "User chose to keep app sleeping";
                        reasonText.style.color = "#6b7280";
                    }
                }
            });

            // ===== STAGE 1: ADAPTIVE CONNECTIVITY =====
            function runConnectivityLogic() {
                if (!connectivityText || !connectivityStatus) return; 
                
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const homeTimezone = TRAINED_MODEL.connectivity.home_timezone;

                if (userTimezone === homeTimezone && !isSimulatedTravel) {
                    connectivityText.textContent = `You are in your home zone (${userTimezone}). Wi-Fi is active.`;
                    connectivityStatus.innerHTML = `<span class="text-green-700 font-medium">Status: Wi-Fi Active</span>`;
                    connectivityStatus.className = "flex items-center p-3 bg-green-50 border border-green-200 rounded-lg";
                } else {
                    const displayZone = isSimulatedTravel ? "VPN/Travel" : userTimezone;
                    connectivityText.textContent = `Travel detected (${displayZone}). We've temporarily disabled Wi-Fi scanning to save power.`;
                    connectivityStatus.innerHTML = `<span class="text-blue-700 font-medium">Status: Wi-Fi Scanning Paused</span>`;
                    connectivityStatus.className = "flex items-center p-3 bg-blue-50 border border-blue-200 rounded-lg";
                }
            }

            runResourceAllocation();
            runConnectivityLogic();

            // Auto-refresh IRA every hour to show current hour's apps
            setInterval(() => {
                runResourceAllocation();
            }, 60 * 60 * 1000); // Refresh every hour

        });
    </script>
</body>
</html>